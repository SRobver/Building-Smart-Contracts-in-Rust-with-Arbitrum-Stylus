# Counter Contract with Arbitrum Stylus

## Introduction

This guide demonstrates building a simple yet complete smart contract using Rust and Arbitrum Stylus - a "Hello World" counter that showcases the fundamentals of WebAssembly-based smart contract development.

In this tutorial, we'll implement a basic counter contract that maintains a single unsigned integer state variable and provides methods to read, set, and increment its value. This mirrors the classic Solidity counter contract, but leverages Rust's type safety and WebAssembly performance benefits.

**What This Contract Does:**

- **Counter Storage:** Maintains a persistent `number` state variable
- **Read Operations:** `number()` getter to retrieve current value
- **Write Operations:** `setNumber(uint256)` to set a specific value, `increment()` to increase by 1

**Why This Example:**
Counter contracts are the "Hello World" of smart contract development. They demonstrate:

- Basic state management in WebAssembly
- Reading and writing contract storage
- Public method exposure
- Gas-efficient implementations

**Learning Outcomes:**

- Understanding Stylus project structure and configuration
- Implementing contract storage using `sol_storage!` macros
- Creating public methods with the `#[public]` attribute
- Local development and testing workflows
- ABI generation for external interaction

By the end of this guide, you'll have a working counter contract deployed to a local Arbitrum chain, with the foundation to build more complex smart contracts.

## Getting Started

### Prerequisites

- Rust toolchain
- VS Code
- Docker
- Foundry's cast
- Nitro devnode

### Installation

1. Install the Stylus CLI:

```bash
cargo install --force cargo-stylus
```

2. Enable WebAssembly compilation:

```bash
rustup default 1.80
rustup target add wasm32-unknown-unknown --toolchain 1.80
```

3. Verify installation:

```bash
cargo stylus --help
```

4. Clone this repository:

```bash
git clone https://github.com/OffchainLabs/stylus-hello-world && cd stylus-hello-world
```

## Testnet Details

Find all necessary testnet resources—faucets, RPC URLs, etc.—[here](https://docs.arbitrum.io/stylus/reference/testnet-information).

## Local Development Environment

Before deploying to testnet, you'll want to test your contract locally using the Arbitrum Nitro devnode.

**Launch Local Devnode:**

```bash
git clone https://github.com/OffchainLabs/nitro-devnode.git
cd nitro-devnode
./run-dev-node.sh
```

This starts a local Arbitrum chain at `http://localhost:8547` with a pre-funded wallet: `0xb6b15c8cb491557369f3c7d2c287b053eb229daa9c22138887752191c9520659`.

**Verify the devnode is running:**

```bash
cast block-number --rpc-url http://localhost:8547
```

Should return `0` or higher, confirming the local chain is active.

**Stop the devnode when done:**

```bash
docker compose down
```

Use this local environment to deploy and test your counter contract before moving to testnet.

## Contract Validation

Before deploying, validate your contract can be deployed and activated onchain:

```bash
cargo stylus check
```

Docker must be running for this command.

Example successful output:

```
Finished release [optimized] target(s) in 1.88s
Reading WASM file at stylus-hello-world/target/wasm32-unknown-unknown/release/stylus-hello-world.wasm
Compressed WASM size: 8.9 KB
Program succeeded Stylus onchain activation checks with Stylus version: 1
```

## Contract Deployment

### 1. Estimate Gas (without transaction)

```bash
cargo stylus deploy \
  --private-key-path=<PRIVKEY_FILE_PATH> \
  --estimate-gas
```

Example output:

```
Estimated gas for deployment: 1874876
```

### 2. Deploy Contract

```bash
cargo stylus deploy \
  --private-key-path=<PRIVKEY_FILE_PATH>
```

Successful output:

```
Compressed WASM size: 8.9 KB
Deploying program to address 0x457b1ba688e9854bdbed2f473f7510c476a3da09
Estimated gas: 1973450
Submitting tx...
Confirmed tx 0x42db…7311, gas used 1973450
Activating program at address 0x457b1ba688e9854bdbed2f473f7510c476a3da09
Estimated gas: 14044638
Submitting tx...
Confirmed tx 0x0bdb…3307, gas used 14044638
```

Your contract is now deployed and activated!

## ABI Generation

Generate the Solidity ABI for your contract:

```bash
cargo stylus export-abi
```

This will output:

```solidity
/**
 * This file was automatically generated by Stylus and represents a Rust program.
 * For more information, please see [The Stylus SDK](https://github.com/OffchainLabs/stylus-sdk-rs).
 */

// SPDX-License-Identifier: MIT-OR-APACHE-2.0
pragma solidity ^0.8.23;

interface ICounter {
    function number() external view returns (uint256);

    function setNumber(uint256 new_number) external;

    function mulNumber(uint256 new_number) external;

    function addNumber(uint256 new_number) external;

    function increment() external;
}
```

## Interacting with the Contract

### Rust Interaction Example

See `examples/counter.rs` for a complete example using ethers-rs:

```rust
abigen!(
    Counter,
    r#"[
        function number() external view returns (uint256)
        function setNumber(uint256 number) external
        function increment() external
    ]"#
);

// Configure environment with:
// RPC_URL, STYLUS_CONTRACT_ADDRESS, PRIV_KEY_PATH
// in a .env file or environment variables

let provider = alchemy_provider(&rpc_url).await?;
let client = LocalWallet::from_str(&priv_key, &provider.clone())?;
let counter = Counter::new(counter_address, &provider.into());

// Read current value
let current_value = counter.number().call().await?;
println!("Current counter value: {:?}", current_value);

// Update counter value
let _ = counter.increment().send().await?.await?;
let new_value = counter.number().call().await?;
println!("New counter value: {:?}", new_value);
```

Run with:

```bash
cargo run --example counter
```

### Foundry's Cast

#### Calling a Function

```bash
cast call \
  --rpc-url <RPC_URL> \
  --private-key <PRIVATE_KEY> \
  [contract-address] "number()(uint256)"
```

Example output:

```
0
```

#### Sending a Transaction

```bash
cast send \
  --rpc-url <RPC_URL> \
  --private-key <PRIVATE_KEY> \
  [contract-address] "increment()"
```

After incrementing, you can call the number() function again to see the updated value.

## Testing

The template includes a test file (`tests/test_counter.rs`) that demonstrates how to test your Stylus contract:

```rust
#[cfg(test)]
mod test {
    use super::*;
    use alloy_primitives::address;
    use stylus_sdk::testing::*;

    #[test]
    fn test_counter_operations() {
        let vm = TestVM::default();
        let mut contract = Counter::from(&vm);

        assert_eq!(contract.number().unwrap(), U256::ZERO);

        contract.increment().unwrap();
        assert_eq!(contract.number().unwrap(), U256::from(1));

        contract.set_number(U256::from(5)).unwrap();
        assert_eq!(contract.number().unwrap(), U256::from(5));
    }
}
```

Run tests with:

```bash
cargo test
```

## Customization Options

- Add dependencies in `Cargo.toml` for advanced features
- Use `cargo stylus new --minimal` for a leaner setup
- For advanced wasm optimization, consult [cargo-stylus documentation](https://github.com/OffchainLabs/cargo-stylus)
